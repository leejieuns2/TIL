# 🖥 Section 3. 프로세스 동기화

## 📍 프로세스 간 통신
- 프로세스는 독립적으로 실행되기도 하지만 다른 프로세스와 데이터를 주고받으며 통신하는 경우도 있다.
- 통신은 한 컴퓨터내에서 실행되고 있는 다른 프로세스와 할 수도 있고, 네트워크가 연결된 다른 컴퓨터의 프로세스와 할수도 있다.

1. 한 컴퓨터 내에서 프로세스 간 통신
    1. 파일 (file)
        - 통신하려는 프로세스들이 하나의 파일을 이용해 읽고 쓰는 방법
    2. 파이프 (pipe)
        - 운영체제가 생성한 파이프를 이용해 데이터를 읽고 쓰는 방법
    
2. 쓰레드를 이용한 프로세스 간 통신
- 한 프로세스 내에서 쓰레드 간 통신을 하는 것.
- 쓰레드는 서로 코드, 데이터, 힙 영역을 공유하고 스택 영역만을 고유하게 가지고 있음.
- 데이터 영역에 있는 전역변수나 힙을 이용하면 통신 가능

3. 네트워크를 이용한 프로세스 간 통신
- 운영체제가 제공하는 소켓 통신 활용
- 다른 컴퓨터에 있는 함수를 호출하는 RPC (원격 프로세서 호출) 를 이용해 호출하는 방법.

<br>

## 📍 공유자원과 임계구역
- 프로세스 간 통신을 할 때 공동으로 이용하는 변수나 파일들을 공유 자원이라고 함
- 공유 자원은 여러 프로세스가 공유하고 있기 때문에 각 프로세스의 접근 순서에 따라 결과가 달라질 수 있음.
- 또한 문맥 교환으로 시분할 처리를 하기 때문에 어떤 프로세스가 먼저 실행되고 나중에 실행되는지 예측이 힘듬.
- 따라서 연산 결과를 예측하기 힘들어 여기서 발생하는 문제가 "동기화" 문제

### 임계 구역과 경쟁 조건 예제 코드
```java
// 물약을 먹는 코드
int currentHealth = GetHealth();
health = currentHealth + 50; // 체력 50 증가

// 공격받는 코드
int currentHealth = GetHealth();
health = currentHealth - 10; // 체력 10 감소
```

- 다음의 예시 코드에서 먼저 실행되는 코드의 라인이 어느 것이냐에 따라 최종 health의 값이 달라질 수 있음
- health라는 공유 자원을 여러 프로세스가 동시에 사용하기 때문에 발생한 현상
- `임계 구역 (Critical Section)` : 여러 프로세스가 동시에 사용하면 안되는 구역
- `경쟁 조건 (Race condition)` : 공유 자원을 서로 사용하기 위해 경쟁하는 것

### 상호 배제 매커니즘의 요구사항 3가지
1. 임계 영역엔 동시에 하나의 프로세스만 접근
2. 여러 요청에도 하나의 프로세스의 접근만 허용
3. 임계 구역에 들어간 프로세스는 빠르게 나와야 함. (다른 프로세스들이 대기 상태일 수 있으므로)

<br>

## 📍 세마포어

### 세마포어란 ?
- 상호 배제의 대표적인 매커니즘 중 하나
- 경쟁 조건이 발생했을 때 사용하는 정수형 변수

### 세마포어 예제 코드
```java
// 세마포어 선언
int s = 1;

// 물약을 먹는 코드
wait(s); // 열쇠를 요청해서 열쇠를 받고 문을 잠금
        
int currentHealth = GetHealth();
health = currentHealth + 50; // 체력 50 증가
signal(s); // 방에서 나와 문지키는 직원에게 열쇠 반납
        
// 공격받는 코드
wait(s); // 열쇠를 요청해서 열쇠를 받고 문을 잠금        
int currentHealth = GetHealth();
health = currentHealth - 10; // 체력 10 감소
signal(s);  // 방에서 나와 문지키는 직원에게 열쇠 반납
```
- 위의 예시 코드처럼 세마포어 변수를 사용하면 공유 자원에 여러 프로세스가 동시에 접근하지 못하기 때문에 동기화 문제가 발생하지 않을 수 있음.
- 세마포어 변수는 1이 아닐 수 있음. (단지 정수형 변수일 뿐임)
- 세마포어의 단점
    - wait(), signal() 함수 호출 순서가 잘못되면 경쟁 조건을 해결하지 못할 수 있음.
    - 이를 해결한 방법이 모니터

<br>

## 📍 모니터
- 세마포어의 단점을 해결한 상호배제 매커니즘
- 따로 운영체제가 처리하는 것이 아니라 프로그래밍 언어 차원에서 지원. 대표적으로 자바.

### 모니터 예제 코드
```java
public class Health {
    private int health = 100;
    synchronized void increase(int amount) {
        health += amount;
    }
    synchronized void decrease(int amount) {
        health -= amount;
    }
}
```
- 자바에서 synchronized라는 키워드를 사용하면 동시의 여러 프로세스에서 실행할 수 없음. (싱호배제 일어남)
- `increase()` 함수가 실행되고 있는 동안에는 `decrease()` 함수는 실행될 수 없음

<br>